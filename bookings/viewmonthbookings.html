<html>

<head>
	<link rel="stylesheet" href="../css/bootstrap.min.css">
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/jquery-3.4.1.min.js"></script>
	<script src="../js/gijgo.min.js" type="text/javascript"></script>
	<link href="../css/gijgo.min.css" rel="stylesheet" type="text/css" />
	<style>
		tr {
			line-height: 50px;
			min-height: 50px;
			height: 50px;
		}
	</style>
</head>

<body>
	<script>
		let d = new Date;
		let currDate = "";
		let month_dates = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
		let month_names = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

		let date = d.getDate() + 1;
		let month = d.getMonth();
		let year = d.getFullYear();
		let day;

		function fillCalendar(addMonth) {
			if (addMonth == 0) {
				day = (Number(date) + d.getDay() + 1) % 7;
			}
			if (addMonth == 1) {
				day = (day + month_dates[month]) % 7;
			}

			month += addMonth;
			if (month == 12) {
				month = 0;
				year++;
			}
			if (month == -1) {
				month = 11;
				year--;
			}
			if (year % 4 == 0)
				month_dates[1] = 29;
			else
				month_dates[1] = 28;


			if (addMonth == -1) {
				day = 7 - ((month_dates[month] - day) % 7);
				day = (day == 7) ? 0 : day;
			}

			let table = document.getElementById("table-body");
			let html = "";
			let totalBoxes = day + month_dates[month];
			let count = 0;

			while (count < day) {
				if (count % 7 == 0) {
					html += "<tr'>";
				}
				html += "<td class='text-right btn-secondary'>";
				count++;
			}
			count = 1;
			let tmpd = day;

			while (count <= month_dates[month]) {
				if (tmpd % 7 == 0) {
					html += "<tr>";
				}
				html += "<td class='text-right' id='date" + count + "' onclick='displayBookings(" + count + ", " + (month + 1) + ", " + year + ")'>" + count;
				count++;
				tmpd++;
			}
			table.innerHTML = html;

			let name_space = document.getElementById("month name");
			name_space.innerHTML = "<div align='center'><h2>" + month_names[month] + " " + year + "<h2></div>";

			count = 1;
			while (count <= month_dates[month]) {
				displaySlots(count, month, year);
				count++;
			}
		}

		function displayBookings(date, month, year) {
			document.location.href = "viewdaybookings.html?date=" + date + "&month=" + month + "&year=" + year;
		}

		function displaySlots(date, month, year) {
			let currDate = fabricateDate(date, month, year);
			let box = document.getElementById("date" + date);

			let request;

			try {
				request = new XMLHttpRequest();
			} catch (e) {
				try {
					request = new ActiveXObject("Msxml2.XMLHTTP");
				} catch (e) {
					try {
						request = new ActiveXObject("Microsoft.XMLHTTP");
					} catch (e) {
						return false;
					}
				}
			}

			let result;
			request.onreadystatechange = function () {
				if (request.readyState == 4) {
					result = request.responseText;
					if (result == 4) {
						box.classList.add("btn-danger");
					}
					else if (result == 0) {
						box.classList.add("btn-info");
					}
					else if (result < 4 && result > 0) {
						box.classList.add("btn-warning");
					}
				}
			}

			let queryString = "?date=" + currDate;
			request.open("GET", "findslotstaken.php" + queryString, true);
			request.send(null);
		}

		function fabricateDate(date, month, year) {
			let m = month + 1;
			let d = date;
			m = (m < 10) ? "0" + m : m;
			d = (d < 10) ? "0" + d : d;
			currDate = year + " " + m + " " + d;
			return currDate;
		}
	</script>
	<div class="container-fluid">
		<br>
		<br>
		<div class="row">
			<div class="col-sm-3">
				<div align="center">
					<div class="btn btn-primary" onclick="fillCalendar(-1)">Previous Month</div>
				</div>
			</div>
			<div class="col-sm-6" id="month name"></div>
			<div class="col-sm-3">
				<div align="center">
					<div class="btn btn-primary" onclick="fillCalendar(1)">Next Month</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">
			<div class="col-sm-2"></div>
			<div class="col-sm-8">
				<table class="table table-bordered" style="table-layout: fixed; width: 100%;">
					<thead class="thead thead-dark">
						<th class="text-center">Sun</th>
						<th class="text-center">Mon</th>
						<th class="text-center">Tue</th>
						<th class="text-center">Wed</th>
						<th class="text-center">Thu</th>
						<th class="text-center">Fri</th>
						<th class="text-center">Sat</th>
					</thead>
					<tbody id="table-body">
						<script>fillCalendar(0);</script>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</body>

</html>